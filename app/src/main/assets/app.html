<!DOCTYPE html>

<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Pen and Paper Tracker</title>
  <style>
body {
  background-color: #ccc;
  font-family: Arial, sans-serif;
  padding: 20px;
}

.tabs {
  display: flex;
  overflow-x: auto;
  white-space: nowrap;
}

.tab-button {
  flex-shrink: 0;
  background-color: #888;
  color: white;
  border: none;
  padding: 15px 20px;
  cursor: pointer;
  margin-right: 5px;
  border-radius: 5px 5px 0 0;
}
.tab-button.active {
  background-color: #444;
}
.tab-content {
  display: none;
}
.tab-content.active {
  display: block;
}

.section {
  margin-bottom: 30px;
}
.field {
  margin: 10px 0;
}

label {
  display: block;
  margin-bottom: 5px;
}

input[type="text"],
input[type="number"],
input[type="email"],
input[type="password"],
select {
  padding: 6px;
  font-size: 14px;
  border-radius: 4px;
  border: 1px solid #ccc;
  width: 100%;
}


#saveBtn {
  background-color: #444;
  color: white;
  padding: 12px 20px;
  font-size: 16px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  margin-top: 10px;
}
#saveBtn:hover {
  background-color: #333;
}

.calculator {
  display: flex;
  gap: 10px;
  margin-top: 5px;
}
.calculator input {
  flex: 1;
}
.calculator button {
  padding: 10px;
  font-size: 18px;
  background-color: #666;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}
.calculator button:hover {
  background-color: #444;
}

.date-row {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-right: 30px;
}
.date-row .field {
  flex: 1;
  min-width: 120px;
}

select.big-select {
  font-size: 16px;
  padding: 10px;
}

.npc-inner-tab {
  display: none;
}
.npc-inner-tab.active {
  display: block;
}
.hidden {
  display: none;
}

.card {
  background-color: white;
  border-radius: 10px;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
  padding: 10px 15px;
  margin-bottom: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.card span {
  font-weight: bold;
  cursor: pointer;
  flex-grow: 1;
}
.card span:hover {
  text-decoration: underline;
}
.card button {
  background-color: #444;
  color: white;
  border: none;
  border-radius: 5px;
  padding: 5px 10px;
  cursor: pointer;
}

.npc-grid {
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.npc-row {
  display: flex;
  gap: 10px;
}
.npc-row input,
.npc-block textarea {
  width: 100%;
}
.npc-block {
  display: block;
}

.checkbox-row {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}
.checkbox-row label {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: bold;
  margin: 0;
}

.big-button {
  background-color: #444;
  color: white;
  padding: 12px 20px;
  font-size: 16px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  margin-top: 10px;
}
.big-button:hover {
  background-color: #333;
}

#npc-detail-tab {
  min-height: 280vh;
  padding-bottom: 260px;
  box-sizing: border-box;
  overflow-y: auto;
}

#eigenschaftenContainer {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  justify-content: center;
  align-items: center;
  text-align: initial;
}

.effekte-wrapper {
  background-color: #f9f9f9;
  border: 1px solid #aaa;
  border-radius: 8px;
  padding: 15px;
  margin-top: 10px;
  font-size: 16px;
  box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.1);
  transition: all 0.3s ease;
  white-space: pre-line;
  word-wrap: break-word;
}
.effekte-wrapper.hidden {
  display: none;
}

#modPopup {
  text-align: left; /* erzwingt Linksb√ºndigkeit f√ºr Checkbox-Labels */
}

#modPopup label {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: normal;
  margin-bottom: 8px;
  white-space: normal;
  width: 100%; /* optional, sorgt f√ºr gleichm√§√üige Breite */
}

#modPopup input[type="checkbox"] {
  flex-shrink: 0;
}

.checkbox-column {
  display: flex;
  flex-direction: column;
  gap: 10px;
  align-items: flex-start;
  margin-bottom: 10px;
}

  </style>
</head>
<body>

  <div class="tabs">
    <button class="tab-button active" onclick="showTab('statusTab')">Status</button>
    <button class="tab-button" onclick="showTab('geldTab')">Geldbeutel</button>
	<button class="tab-button" onclick="showTab('fernkampfTab')">Fernkampf</button>
	<button class="tab-button" onclick="showTab('npcTab')">NPC-Sammlung</button>
    <button class="tab-button" onclick="showTab('datumTab')">Datum</button>
	<button class="tab-button" onclick="showTab('tabManagerTab')">Reiter verwalten</button>
  </div>


  <div id="statusTab" class="tab-content active">
    <div class="section">
      <h2>
  Charakterstatus
  <button onclick="toggleFilterPopup()" style="margin-left: 10px;">‚öôÔ∏è Filter</button>
  <button onclick="toggleEigenschaftenPopup()" style="margin-left: 10px;">üìä Eigenschaften</button>
</h2>

<div id="filterPopup" class="hidden" style="background:white; border:1px solid #999; padding:10px; border-radius:8px; position:absolute; z-index:1000;">
  <h3>Filter</h3>
  <div id="filterOptions"></div>
  <button onclick="closeFilterPopup()">Schlie√üen</button>
</div>
<div id="eigenschaftenPopup" class="hidden" style="background:white; border:1px solid #999; padding:10px; border-radius:8px; position:absolute; z-index:1000;">
  <h3>Eigenschaften & Werte</h3>
  <div id="eigenschaftenContainer" ></div>
  <button onclick="closeEigenschaftenPopup()">Schlie√üen</button>
</div>
      <!-- Status-Felder -->
      <div id="statusFields"></div>
    </div>
<h3 style="margin-top: 30px;">Effekte</h3>
<div id="effekteWrapper" class="effekte-wrapper hidden">
  <div id="effekteOutput"></div>
</div>
<div class="field">
  <label>Neue Wunde hinzuf√ºgen</label>
  <div style="display:flex; gap:10px; flex-wrap: wrap;">
    <select id="neueWundenArt">
      <option value="">Art der Wunde‚Ä¶</option>
      <option value="Generisch">Generisch</option>
      <option value="Kopf">Kopf</option>
      <option value="Brust">Brust</option>
      <option value="Waffe">Waffe tragender Arm</option>
      <option value="Schild">Waffenloser Arm</option>
      <option value="Bauch">Bauch</option>
      <option value="Bein">Bein</option>
    </select>
    <select id="neueWundenAnzahl">
      <option value="1">1</option>
      <option value="2">2</option>
    </select>
    <button onclick="wundeHinzuf√ºgen()">‚ûï Hinzuf√ºgen</button>
  </div>
</div>

<div class="field">
  <label>Aktuelle Wunden</label>
  <ul id="wundenListe" style="list-style: none; padding-left: 0;"></ul>
</div>

  </div>

  <div id="geldTab" class="tab-content">
    <div class="section">
      <h2>Geldbeutel</h2>
      <!-- Geld-Felder -->
      <div id="geldFields"></div>
    </div>
  </div>

  <div id="npcTab" class="tab-content">
    <div class="section">
      <h2>NPC-Sammlung</h2>
	  
     <div id="region-tab" class="npc-inner-tab active">
  <h3>Regionen</h3>
  <div>
    <button onclick="setRegionSort('newest')">Neueste zuerst</button>
    <button onclick="setRegionSort('asc')">A-Z</button>
    <button onclick="setRegionSort('desc')">Z-A</button>
  </div>
  <ul id="region-list"></ul>
  <input id="new-region-name" placeholder="Neue Region" />
  <button class="big-button" onclick="addRegion()">Hinzuf√ºgen</button>
</div>

<div id="npc-region-tab" class="npc-inner-tab">
  <h3>NPCs in <span id="current-region-name"></span></h3>
  <div>
    <button onclick="setNPCSort('newest')">Neueste zuerst</button>
    <button onclick="setNPCSort('asc')">A-Z</button>
    <button onclick="setNPCSort('desc')">Z-A</button>
  </div>
  <ul id="npc-list"></ul>
  <input id="new-npc-name" placeholder="Neuer NPC" />
  <button class="big-button" onclick="addNPC()">Hinzuf√ºgen</button>
  <button class="big-button" onclick="backToRegions()">Zur√ºck zu Regionen</button>
</div>

<div id="npc-detail-tab" class="npc-inner-tab">
  <h3>NPC Detail</h3>
  <div style="display: flex; justify-content: space-between; align-items: center;">
  <h3>NPC Detail</h3>
  <div>
    <button onclick="showRegionMoveSelect()" title="NPC verschieben">‚öôÔ∏è</button>
  </div>
</div>

<div id="npc-move-container" style="display: none; margin-bottom: 10px;">
  <label>NPC verschieben in die Region:
    <select id="npcMoveSelect"></select>
    <button onclick="moveNPCToRegion()">Verschieben</button>
  </label>
</div>
  <button class="big-button" onclick="backToNPCs()">‚Üê Zur√ºck zu NPCs</button>
  <div class="npc-grid">
    <div class="npc-row">
      <label>Name:<input id="npcName" /></label>
      <label>Rasse:<input id="npcRace" /></label>
    </div>
    <div class="npc-row">
      <label>Alter:<input id="npcAge" /></label>
      <label>Beruf:<input id="npcRole" /></label>
    </div>
    <div class="npc-block">
  <label>Quest:<textarea id="npcQuest" style="width: 100%; height: 80px;"></textarea></label>
</div>
   <div class="npc-block">
    <label>Interaktion:<textarea id="npcInteraction" style="width: 100%; height: 80px;"></textarea></label>
  </div>
    <div class="npc-block">
    <label>Meinung:<textarea id="npcOpinion" style="width: 100%; height: 80px;"></textarea></label>
  </div>
    <div>
      <h4>Verbindungen</h4>
		<div class="checkbox-row">
			<label>
				<input type="checkbox" id="globalRelationToggle" onchange="renderRelationOptions()">
				√úberregional
			</label>
		</div>

      <input id="relationLabel" placeholder="z.B. Bruder von" />
      <select id="relationTarget"></select>
      <button class="big-button" onclick="addRelation()">Verkn√ºpfung hinzuf√ºgen</button>
      <ul id="relationsList"></ul>
    </div>
		  <button id="saveBtn">Speichern</button>
  </div>
</div>
	 
      <div id="npcFields"></div>
    </div>
  </div>

<div id="fernkampfTab" class="tab-content">
  <div class="section">
    <h2>Fernkampf</h2>
<button onclick="toggleFernkampfEinstellungen()" class="big-button">‚öôÔ∏è Einstellungen</button>
<button onclick="toggleBogenPopup()" class="big-button">‚ûï Bogen hinzuf√ºgen</button>
<!-- ‚öôÔ∏è Einstellungen Popup -->
<!-- ‚öôÔ∏è Einstellungen Popup -->
<div id="fernkampfEinstellungen" class="hidden" style="background:white; border:1px solid #999; padding:10px; border-radius:8px; position:absolute; z-index:1000;">
  <h3>Einstellungen</h3>

  <div class="checkbox-row">
  <label><input type="checkbox" id="trefferzonenSystem"> Mit Trefferzonen</label>
  <label><input type="checkbox" id="mitMeisterErschwernis"> Mit "Nach Meisterentscheid weitere Erschwernisse"</label>
</div>

  <h4>Vorteile</h4>
  <div class="checkbox-row">
    <label><input type="checkbox" id="vorteilDaemmerung"> D√§mmerungssicht</label>
  </div>
  <div class="checkbox-row">
    <label><input type="checkbox" id="vorteilNacht"> Nachtsicht</label>
  </div>
  <div class="checkbox-row">
    <label><input type="checkbox" id="vorteilEntfernungssinn"> Entfernungssinn</label>
  </div>

  <h3>Nachteile</h3>

  <div class="checkbox-row">
<input type="checkbox" id="checkboxEinaugig"> Ein√§ugig
<input type="checkbox" id="checkboxFarbenblind"> Farbenblind
 <input type="checkbox" id="nachtblind"> Nachtblind
</div>

  <h4>Sonderfertigkeit</h4>
  <select id="sonderfertigkeit">
    <option value="N">Normal (N)</option>
    <option value="S">Scharfsch√ºtze (S)</option>
    <option value="M">Meistersch√ºtze (M)</option>
  </select>

  <br><br>
  <button onclick="toggleFernkampfEinstellungen()">Schlie√üen</button>
</div>

<!-- ‚ûï Bogen hinzuf√ºgen Popup -->
<div id="bogenPopup" class="hidden" style="background:white; border:1px solid #999; padding:10px; border-radius:8px; position:absolute; z-index:1000; max-width: 400px;">
  <h3>Bogen hinzuf√ºgen</h3>
<div style="display: flex; gap: 5px; align-items: center;">
  <input type="number" id="distSehrNah" placeholder="10" style="width: 30px;"> /
  <input type="number" id="distNah" placeholder="25" style="width: 30px;"> /
  <input type="number" id="distMittel" placeholder="50" style="width: 30px;"> /
  <input type="number" id="distWeit" placeholder="100" style="width: 30px;"> /
  <input type="number" id="distExtrem" placeholder="200" style="width: 30px;">
</div>
<!-- Name und Button zum Hinzuf√ºgen -->
<div style="margin-top: 10px;">
  <input type="text" id="bogenName" placeholder="Name des Bogens" style="width: 200px;">
  <button onclick="bogenHinzufuegen()">‚ûï Hinzuf√ºgen</button>
</div>

<!-- Dropdown zur Auswahl eines gespeicherten Bogens -->
<div style="margin-top: 10px;">
  <label>Gespeicherte B√∂gen:</label>
  <select id="bogenDropdown" onchange="ausgewaehltenBogenAnzeigen()">
    <option value="">‚Äì bitte w√§hlen ‚Äì</option>
  </select>
</div>

<!-- Platzhalter f√ºr Bearbeitungs- und L√∂schfunktionen -->
<div id="bogenAktionen" style="margin-top: 10px; display:none;">
  <button onclick="bogenBearbeiten()">‚öôÔ∏è Bearbeiten</button>
  <button onclick="bogenLoeschen()">‚ùå L√∂schen</button>
</div>
  <button onclick="toggleBogenPopup()">Schlie√üen</button>
</div>
<div class="field">
  <label>Entfernung w√§hlen</label>
  <select id="entfernungDropdown">
    <option>Bitte zuerst Werte im Bogen-Popup eingeben‚Ä¶</option>
  </select>
</div>

<!-- Ein√§ugig -->
<div id="einaugigRow" class="checkbox-row">
  <label><input type="checkbox" id="einaugigDist10"> Ein√§ugig und Distanz &lt; 10 Schritt?</label>
</div>

<!-- Farbenblind -->
<div id="farbenblindRow" class="checkbox-row">
  <label><input type="checkbox" id="farbenblindDist50"> Farbenblind und Distanz &gt; 50 Schritt?</label>
</div>

<div class="field">
  <label>Zielgr√∂√üe w√§hlen</label>
  <select id="zielgroesseDropdown">
    <option value="8">Winzig (M√ºnze, Drachenauge, Maus, Kr√∂te): +8</option>
    <option value="6">Sehr klein (Schlange, Fasan, Katze, Rabe): +6</option>
    <option value="4">Klein (Wolf, Reh, Schaf): +4</option>
    <option value="2">Mittel (Mensch, Elf, Ork, Goblin, Zwerg): +2</option>
    <option value="0">Gro√ü (Pferd, Steppenrind, Oger, Troll): ¬±0</option>
    <option value="-2">Sehr gro√ü (Scheunentor, Drache, Elefant, Riese): ‚Äì2</option>
  </select>
</div>
<!-- Deckung -->
<div class="field">
  <label>Deckung ausw√§hlen</label>
  <select id="deckungDropdown">
    <option value="0">Keine Deckung (+0)</option>
    <option value="2">Halbe Deckung (+2)</option>
    <option value="4">Dreiviertel-Deckung (+4)</option>
  </select>
</div>

<!-- Bewegung -->
<div class="field">
  <label>Bewegung des Ziels</label>
  <select id="bewegungDropdown">
    <option value="-4">Unbeweglich (‚Äì4)</option>
    <option value="-2">Fest montiert (‚Äì2)</option>
    <option value="0">Leichte Bewegung (+0)</option>
    <option value="2">Schnelle Bewegung (+2)</option>
    <option value="4">Sehr schnelle Bewegung (+4)</option>
  </select>
</div>

<!-- Sichtverh√§ltnisse -->
<div class="field">
  <label>Sichtverh√§ltnisse</label>
  <select id="sichtDropdown">
 <option value='{"basis":0,"daemmerung":0,"nacht":0}'>Normal (Zielgr√∂√üe +0)</option>   
   <option value='{"basis":4,"daemmerung":0,"nacht":0}'>Nebel (Zielgr√∂√üe +4)</option>
    <option value='{"basis":2,"daemmerung":1,"nacht":0}'>D√§mmerung (+2 / +1 bei D√§mmerungssicht, 0 bei Nachtsicht)</option>
    <option value='{"basis":4,"daemmerung":2,"nacht":0}'>Mondlicht (+4 / +2 bei D√§mmerungssicht, 0 bei Nachtsicht)</option>
    <option value='{"basis":6,"daemmerung":3,"nacht":0}'>Sternenlicht (+6 / +3 bei D√§mmerungssicht, 0 bei Nachtsicht)</option>
    <option value='{"basis":8,"daemmerung":4,"nacht":0}'>Finsternis (+8 / +4 bei D√§mmerungssicht, 0 bei Nachtsicht)</option>
    <option value='{"basis":8,"daemmerung":8,"nacht":8}'>Unsichtbares Ziel (+8)</option>
  </select>
</div>
<div class="field">
  <label>Kampfget√ºmmel</label>
  <div class="checkbox-row" style="align-items: center;">
    <label><input type="checkbox" id="kampfgetuemmelH"> H</label>
    <label><input type="checkbox" id="kampfgetuemmelNS"> NS</label>
    <span style="margin-left: 10px;">Teilnehmer:</span>
    <input type="number" id="kampfTeilnehmer" min="0" style="width: 30px;" />
  </div>
</div>

<div class="field">
  <label>Sonstige Modifikatoren</label>
  <button onclick="toggleModPopup()" class="big-button">Sonstige Modifikatoren</button>
<div id="modPopup" class="hidden" style="background:white; border:1px solid #999; padding:10px; border-radius:8px; position:absolute; z-index:1000; max-width: 400px;">
  <h3>Sonstige Modifikatoren</h3>
 
<label class="popup-checkbox"><input type="checkbox" id="modSteilschussUnten">Steilschuss nach unten +2</label>
<label class="popup-checkbox"><input type="checkbox" id="modSteilschussOben">Steilschuss nach oben +4</label>
<label class="popup-checkbox"><input type="checkbox" id="modBoigerSeitenwind">b√∂iger Seitenwind +4</label>
<label class="popup-checkbox"><input type="checkbox" id="modStarkerBoigerSeitenwind">starker, b√∂iger Seitenwind +8</label>
<label class="popup-checkbox"><input type="checkbox" id="modSchnellschuss">Schnellschuss (f√ºr N: +2, S: +1, M:0)</label>
<label class="popup-checkbox"><input type="checkbox" id="modzweiterSchuss">Zweiter Schuss in der Kampfrunde +4</label>

    <button onclick="toggleModPopup()">Schlie√üen</button>
</div>
</div>

<div id="meisterErschwernisBlock" class="hidden">
  <div class="field">
    <label for="meisterErschwernis">Nach Meisterentscheid weitere Erschwernisse:</label>
    <input type="number" id="meisterErschwernis" style="width: 60px;" />
  </div>
  </div>
  
  <div class="field">
    <label for="Zielenerleichertung">Aktionen gezielt:</label>
    <input type="number" id="aktionenZielenAnzahl" min="0" max="99" style="width: 60px;" />
  </div>

<div id="trefferzonenBlock">
<p style="font-weight: bold; margin-bottom: 5px;">Trefferzonen</p>
<div class="checkbox-row">
  <label>
    <input type="checkbox" id="ohneTrefferzone" onchange="document.getElementById('trefferzoneDropdown').disabled = this.checked; document.getElementById('trefferzonenTyp').disabled = this.checked;">
    Keine Trefferzone ausw√§hlen
  </label>
</div>
<div class="field" style="display: flex; align-items: center; gap: 10px;">
  <div style="width: 80px;">
    <select id="trefferzonenTyp" onchange="aktualisiereTierTrefferzonen()" style="width: 100%;">
      <option value="mensch" selected>Mensch</option>
      <option value="tier">Tier</option>
    </select>
  </div>
  <div style="flex: 1;">
    <!-- Menschliche Trefferzonen -->
<div id="menschTrefferzonen" class="field">
  <select id="trefferzoneDropdown">
    <option value="kopf">Kopf</option>
    <option value="brust">Brust</option>
    <option value="arme">Arme</option>
    <option value="bauch">Bauch</option>
    <option value="beine">Beine</option>
    <option value="handfuss">Hand/ Fu√ü</option>
    <option value="augeherz">Auge/ Herz</option>
  </select>
</div>
<!-- Tier-Trefferzonen nur anzeigen wenn "Tier" gew√§hlt -->
<div id="tierTrefferzonen" class="field hidden">
  <label>Tier-Trefferzonen:</label>
  <select id="tierzoneDropdown">
    <option value="rumpf">Rumpf</option>
    <option value="bein">Bein</option>
    <option value="verwundbar">Verwundbare Stelle</option>
    <option value="kopf">Kopf</option>
    <option value="schwanz">Schwanz</option>
    <option value="sinnesorgane">Sinnesorgane</option>
  </select>
  <p style="font-size: 0.9em; margin-top: 5px;">
    Hinweis: Bei Schwanz Erschwernis bitte manuell bei "Nach Meisterentscheid" eintragen (N +8‚Äì16 / S +5‚Äì11 / M +4‚Äì8).
  </p>
</div>
  </div>
</div>

</div>

   <div class="field" style="margin-top: 20px;">
  <label style="font-size: 18px; font-weight: bold;">Erschwernis / Erleichterung (Endergebnis):</label>
  <div id="erschwernisAnzeige" style="font-size: 24px; font-weight: bold; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 0 5px rgba(0,0,0,0.1);">
    Noch nicht berechnet
  </div>
  <button class="big-button" onclick="berechneFernkampfErschwernis()">Erschwernis berechnen</button>
</div>

  </div>
</div>

  <div id="datumTab" class="tab-content">
    <div class="section">
      <h2>Datum</h2>
      <div class="date-row">
        <div class="field">
          <label>Tag</label>
          <input type="number" id="tag" placeholder="z.‚ÄØB. 12">
        </div>
        <div class="field">
          <label>Monat</label>
          <select id="monat" class="big-select">
            <option value="Praios/ Juli">Praios/ Juli</option>
            <option value="Rondra/ August">Rondra/ August</option>
            <option value="Efferd/ September">Efferd/ September</option>
            <option value="Travia/ Oktober">Travia/ Oktober</option>
            <option value="Boron/ November">Boron/ November</option>
            <option value="Hesinde/ Dezember">Hesinde/ Dezember</option>
            <option value="Firun/ Januar">Firun/ Januar</option>
            <option value="Tsa/ Februar">Tsa/ Februar</option>
            <option value="Phex/ M√§rz">Phex/ M√§rz</option>
            <option value="Peraine/ April">Peraine/ April</option>
            <option value="Ingrimm/ Mai">Ingrimm/ Mai</option>
            <option value="Rahja/ Juni">Rahja/ Juni</option>
            <option value="Namenlose Tage">Namenlose Tage</option>
          </select>
        </div>
        <div class="field">
          <label>Jahr</label>
          <input type="number" id="jahr" placeholder="z.‚ÄØB. 1035">
        </div>
      </div>
    </div>
  </div>
<div id="tabManagerTab" class="tab-content">
  <div class="section">
    <h2>Reiter verwalten</h2>
    <div id="tabManagerOptions" class="checkbox-row"></div>
  </div>
</div>

<button id="saveBtn">Speichern</button>

  <script>
	const eigenschaftenIDs = ["Max. Lebenspunkte","Max. Ausdauer", "Max. Astralpunkte", "Max. Karmalpunkte", "Konstitution"];
    const statusIDs = ["Lebenspunkte", "Ausdauerpunkte", "Ersch√∂pfung", "√úberanstrengung", "Astralpunkte", "Karmalpunkte"];
	const minZeroIDs = ["Ausdauerpunkte", "Ersch√∂pfung", "√úberanstrengung", "Astralpunkte", "Karmalpunkte"];
    const geldIDs = ["Dukaten", "Silber", "Heller", "Kreuzer", "Nordlandbank"];
    const dateIDs = ["tag", "monat", "jahr"];
	const allIDs = [...statusIDs, ...geldIDs, ...dateIDs, ...eigenschaftenIDs];
	const statusZuEigenschaft = {
  "Lebenspunkte": "Max. Lebenspunkte",
  "Astralpunkte": "Max. Astralpunkte",
  "Karmalpunkte": "Max. Karmalpunkte",
  "Ersch√∂pfung": "Konstitution"
};
const allTabs = [
  { id: "statusTab", label: "Status" },
  { id: "geldTab", label: "Geldbeutel" },
  { id: "fernkampfTab", label: "Fernkampf" },
  { id: "npcTab", label: "NPC-Sammlung" },
  { id: "datumTab", label: "Datum" }
];

	const zielgroesseMod = parseInt(document.getElementById("zielgroesseDropdown").value);
	const trefferzonenModifikatoren = {
  kopf:    { N: 10, S: 7,  M: 5 },
  brust:   { N: 6,  S: 4,  M: 3 },
  arme:    { N: 10, S: 7,  M: 5 },
  bauch:   { N: 6,  S: 4,  M: 3 },
  beine:   { N: 8,  S: 5,  M: 4 },
  handfuss:{ N: 16, S: 12, M: 8 },
  augeherz:{ N: 20, S: 13, M: 10 }
};
	
const eigenschaften = [
  { id: "Max. Lebenspunkte", label: "Max. Lebenspunkte" },
  { id: "Max. Ausdauer", label: "Max. Ausdauer" },
  { id: "Max. Astralpunkte", label: "Max. Astralpunkte" },
  { id: "Max. Karmalpunkte", label: "Max. Karmalpunkte" },
  { id: "Konstitution", label: "Konstitution" }
];

function renderGeldFields() {
  const container = document.getElementById("geldFields");
  container.innerHTML = geldIDs.map(createField).join("");
  setupAutoSaveListeners();
}

function renderEigenschaften() {
  const container = document.getElementById("eigenschaftenContainer");
  container.innerHTML = "";

  eigenschaften.forEach(({ id, label }) => {
    // Filter √ºberpr√ºfen
    const zugehoerigerStatus = Object.entries(statusZuEigenschaft).find(([status, eigenschaft]) => eigenschaft === id)?.[0];

    if (zugehoerigerStatus) {
      const sichtbar = JSON.parse(localStorage.getItem("filter_" + zugehoerigerStatus));
      if (sichtbar === false) return; // Feld √ºberspringen
    }

    const wrapper = document.createElement("div");
    wrapper.style.display = "flex";
    wrapper.style.flexDirection = "column";
    wrapper.style.alignItems = "center";
    wrapper.title = label;

    const span = document.createElement("span");
    span.textContent = id;

    const input = document.createElement("input");
    input.type = "number";
    input.id = id;
    input.style.width = "50px";
    input.value = localStorage.getItem(id) || "";
    input.addEventListener("input", () => {
      localStorage.setItem(id, input.value);
    });

    wrapper.appendChild(span);
    wrapper.appendChild(input);
    container.appendChild(wrapper);
  });
// Checkbox "Ausdauernder Zauberer"
const checkboxRow = document.createElement("div");
checkboxRow.className = "checkbox-row";

const checkbox = document.createElement("input");
checkbox.type = "checkbox";
checkbox.id = "vorteilAusdauernderZauberer";
checkbox.checked = JSON.parse(localStorage.getItem("vorteilAusdauernderZauberer")) || false;
checkbox.addEventListener("change", () => {
  localStorage.setItem("vorteilAusdauernderZauberer", checkbox.checked);
  updateEffekteAnzeige();
});

const label = document.createElement("label");
label.textContent = "Vorteil: Ausdauernder Zauberer";
label.prepend(checkbox);

checkboxRow.appendChild(label);
container.appendChild(checkboxRow);
}

function createField(id) {
  let extra = "";
  if (id === "Ausdauerpunkte") {
    extra = `
      <button onclick="atemHolen()" id="atemHolenBtn" style="margin-top:5px;">
        ü´Å Atem holen
      </button>
    `;
  }

  return `
    <div class="field" id="field-${id}">
      <label>${id}</label>
      <div class="calculator">
        <input type="number" id="${id}" placeholder="Ist-Zustand">
        <button onclick="toggleMinus('${id}_change')">‚àí</button>
        <input type="text" id="${id}_change" placeholder="+/- Ver√§nderung" inputmode="numeric">
        <button onclick="applyChange('${id}')">‚Ü∫</button>
      </div>
      ${extra}
    </div>`;
}

function renderStatusFields() {
  const container = document.getElementById("statusFields");

  // Bestehende Werte zwischenspeichern
  const aktuelleWerte = {};
  statusIDs.forEach(id => {
    const input = document.getElementById(id);
    if (input) {
      aktuelleWerte[id] = input.value;
    }
  });

  // 2. Filter anwenden
  const filteredIDs = statusIDs.filter(id => {
    const isChecked = JSON.parse(localStorage.getItem("filter_" + id));
    return isChecked !== false;
  });

  // 3. Neu aufbauen
  container.innerHTML = filteredIDs.map(createField).join("");

  // 4. Gespeicherte Werte wieder eintragen
  filteredIDs.forEach(id => {
    const input = document.getElementById(id);
    if (input) {
      input.value = aktuelleWerte[id] ?? localStorage.getItem(id) ?? "";
    }
  });

  // 5. Listener neu setzen
  container.addEventListener("input", (event) => {
    const target = event.target;
    if (target.tagName.toLowerCase() === "input") {
      localStorage.setItem(target.id, target.value);
      if (statusIDs.includes(target.id)) {
        onStatusChange(target.id);
      }
    }
  });
}

renderGeldFields();

function toggleFilterPopup() {
  const popup = document.getElementById("filterPopup");
  popup.classList.toggle("hidden");
  renderFilterCheckboxes();
}

function closeFilterPopup() {
  document.getElementById("filterPopup").classList.add("hidden");
}

function renderFilterCheckboxes() {
  const container = document.getElementById("filterOptions");
  container.innerHTML = "";
  statusIDs.forEach(id => {
    const isChecked = JSON.parse(localStorage.getItem("filter_" + id)) ?? true;

    const row = document.createElement("div");
    row.className = "checkbox-row";

    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.checked = isChecked;
checkbox.onchange = () => {
  localStorage.setItem("filter_" + id, checkbox.checked);
  renderStatusFields();
  renderEigenschaften();
};


    const label = document.createElement("label");
    label.textContent = id;
    label.prepend(checkbox);

    row.appendChild(label);
    container.appendChild(row);
  });
}

function toggleEigenschaftenPopup() {
  const popup = document.getElementById("eigenschaftenPopup");
  popup.classList.toggle("hidden");
  positionPopup(popup);
}

function closeEigenschaftenPopup() {
  document.getElementById("eigenschaftenPopup").classList.add("hidden");
}

function positionPopup(popup) {
  const button = event.target;
  const rect = button.getBoundingClientRect();
  popup.style.top = rect.bottom + window.scrollY + "px";
  popup.style.left = rect.left + window.scrollX + "px";
}

    // Tab-Logik
    function showTab(id) {
      document.querySelectorAll(".tab-content").forEach(el => el.classList.remove("active"));
      document.getElementById(id).classList.add("active");
      document.querySelectorAll(".tab-button").forEach(btn => btn.classList.remove("active"));
      document.querySelector(`.tab-button[onclick="showTab('${id}')"]`).classList.add("active");
    }

    // Speicherlogik
window.addEventListener("DOMContentLoaded", () => {
  renderStatusFields();
  renderEigenschaften();
  renderGeldFields();
  renderWundenListe();
  aktualisiereBogenDropdown();
  setupFernkampfAutoSave();
  renderTabButtons();
  renderTabManager();


  // Werte aus localStorage eintragen
  allIDs.forEach(id => {
    const saved = localStorage.getItem(id);
    if (saved !== null) {
      const el = document.getElementById(id);
      if (el) el.value = saved;
    }
  });

  // AutoSave-Listener nach dem Rendern setzen
  setupAutoSaveListeners();

  // Regionen laden
  renderRegions();

  // Hash-Navigation ber√ºcksichtigen
  if (location.hash.startsWith("#region-")) {
    const regionIndex = parseInt(location.hash.replace("#region-", ""));
    if (!isNaN(regionIndex) && regions[regionIndex]) openRegion(regionIndex);
  } else if (location.hash.startsWith("#npc-")) {
    const npcIndex = parseInt(location.hash.replace("#npc-", ""));
    if (!isNaN(npcIndex) && currentRegionIndex !== null) openNPCDetail(npcIndex);
  } else {
    backToRegions();
  }
  
  const einaugigCheckbox = document.getElementById("checkboxEinaugig");
document.getElementById("einaugigRow").style.display = einaugigCheckbox.checked ? "flex" : "none";

const farbenblindCheckbox = document.getElementById("checkboxFarbenblind");
document.getElementById("farbenblindRow").style.display = farbenblindCheckbox.checked ? "flex" : "none";

  
  document.getElementById("mitMeisterErschwernis").addEventListener("change", () => {
  const block = document.getElementById("meisterErschwernisBlock");
  const checkbox = document.getElementById("mitMeisterErschwernis");
  block.classList.toggle("hidden", !checkbox.checked);
});

 document.getElementById("trefferzonenSystem").addEventListener("change", () => {
  const block = document.getElementById("trefferzonenBlock");
  const checkbox = document.getElementById("trefferzonenSystem");
  block.classList.toggle("hidden", !checkbox.checked);
});
document.getElementById("checkboxEinaugig").addEventListener("change", () => {
  const row = document.getElementById("einaugigRow");
  row.style.display = document.getElementById("checkboxEinaugig").checked ? "flex" : "none";
});

document.getElementById("checkboxFarbenblind").addEventListener("change", () => {
  const row = document.getElementById("farbenblindRow");
  row.style.display = document.getElementById("checkboxFarbenblind").checked ? "flex" : "none";
});

const gespeicherterBogen = localStorage.getItem("fern_bogenAuswahl");
if (gespeicherterBogen) {
  const dropdown = document.getElementById("bogenDropdown");
  dropdown.value = gespeicherterBogen;
  ausgewaehltenBogenAnzeigen(); // l√§dt automatisch die Entfernungen
}
// Trefferzonen-Typ wiederherstellen (Mensch/Tier)
const gespeicherterTrefferzonenTyp = localStorage.getItem("fern_trefferzonenTyp");
if (gespeicherterTrefferzonenTyp) {
  const trefferzonenSelect = document.getElementById("trefferzonenTyp");
  trefferzonenSelect.value = gespeicherterTrefferzonenTyp;
  aktualisiereTierTrefferzonen(); // Sichtbarkeit anpassen
}

// Speichern bei √Ñnderung
document.getElementById("trefferzonenTyp").addEventListener("change", (e) => {
  localStorage.setItem("fern_trefferzonenTyp", e.target.value);
  aktualisiereTierTrefferzonen(); // Sichtbarkeit wechseln
});

  updateEffekteAnzeige();
});

document.addEventListener("DOMContentLoaded", () => {
  const ersch√∂pfungInput = document.getElementById("Ersch√∂pfung");

  if (ersch√∂pfungInput) {
    ersch√∂pfungInput.addEventListener("input", () => {
      berechneErschoepfungKonsequenzen();
    });
  }
});

["Konstitution", "Ersch√∂pfung", "√úberanstrengung"].forEach(id => {
  const el = document.getElementById(id);
  if (el) {
    el.addEventListener("input", berechneErschoepfungKonsequenzen);
  }
});

function setupAutoSaveListeners() {
  allIDs.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener("input", () => {
        localStorage.setItem(id, el.value);

        if (statusIDs.includes(id)) {
          onStatusChange(id);
        }
      });
    }
  });
}

let wunden = JSON.parse(localStorage.getItem("wunden")) || [];

function wundeHinzuf√ºgen() {
  const art = document.getElementById("neueWundenArt").value;
  const anzahl = parseInt(document.getElementById("neueWundenAnzahl").value);

  if (!art) return;

  wunden.push({ art, anzahl });
  localStorage.setItem("wunden", JSON.stringify(wunden));
  renderWundenListe();
  updateEffekteAnzeige();
}

function wundeL√∂schen(index) {
  wunden.splice(index, 1);
  localStorage.setItem("wunden", JSON.stringify(wunden));
  renderWundenListe();
  updateEffekteAnzeige();
}

function renderWundenListe() {
  const liste = document.getElementById("wundenListe");
  liste.innerHTML = "";

  wunden.forEach((w, i) => {
    const li = document.createElement("li");
    li.style.display = "flex";
    li.style.alignItems = "center";
    li.style.marginBottom = "5px";

    const span = document.createElement("span");
    span.textContent = `${w.anzahl}√ó ${w.art}`;
    li.appendChild(span);

    // ‚ûï nur bei 1x
    if (w.anzahl < 2) {
      const plusBtn = document.createElement("button");
      plusBtn.textContent = "‚ûï";
      plusBtn.style.marginLeft = "10px";
      plusBtn.onclick = () => {
        wunden[i].anzahl = 2;
        localStorage.setItem("wunden", JSON.stringify(wunden));
        renderWundenListe();
        updateEffekteAnzeige();
      };
      li.appendChild(plusBtn);
    }

    // ‚ûñ nur bei 2x
    if (w.anzahl === 2) {
      const minusBtn = document.createElement("button");
      minusBtn.textContent = "‚ûñ";
      minusBtn.style.marginLeft = "5px";
      minusBtn.onclick = () => {
        wunden[i].anzahl = 1;
        localStorage.setItem("wunden", JSON.stringify(wunden));
        renderWundenListe();
        updateEffekteAnzeige();
      };
      li.appendChild(minusBtn);
    }

    // ‚ùå immer
    const deleteBtn = document.createElement("button");
    deleteBtn.textContent = "‚ùå";
    deleteBtn.style.marginLeft = "10px";
    deleteBtn.onclick = () => wundeL√∂schen(i);
    li.appendChild(deleteBtn);

    liste.appendChild(li);
  });
}

function checkUndErh√∂heErsch√∂pfung() {
  const ausdauerEl = document.getElementById("Ausdauerpunkte");
  const maxAusdauerEl = document.getElementById("Max. Ausdauer");
  const ersch√∂pfungEl = document.getElementById("Ersch√∂pfung");

  if (!ausdauerEl || !maxAusdauerEl || !ersch√∂pfungEl) return;

  const ausdauer = parseInt(ausdauerEl.value || 0);
  const maxAusdauer = parseInt(maxAusdauerEl.value || 0);

  if (maxAusdauer <= 0) return;

  const grenzeDrittel = Math.round(maxAusdauer / 3);
  const flagKey = "ausdauerLowFlag";

  if (ausdauer <= grenzeDrittel) {
    if (!localStorage.getItem(flagKey)) {
      let ersch√∂pfung = parseInt(ersch√∂pfungEl.value || 0);
      ersch√∂pfung += 1;
      ersch√∂pfungEl.value = ersch√∂pfung;
      localStorage.setItem("Ersch√∂pfung", ersch√∂pfung);
      localStorage.setItem(flagKey, "true");

      berechneErschoepfungKonsequenzen();
    }
  } else {
    localStorage.removeItem(flagKey);
  }
}

function onStatusChange(changedID) {
  console.log(`Status-Feld "${changedID}" hat sich ge√§ndert.`);

  if (["Ersch√∂pfung", "√úberanstrengung", "Konstitution"].includes(changedID)) {
    berechneErschoepfungKonsequenzen();
    updateEffekteAnzeige();
  }

  // LP oder Ausdauer neu berechnen
  if (["Lebenspunkte", "Ausdauerpunkte", "Max. Lebenspunkte", "Max. Ausdauer"].includes(changedID)) {
    updateEffekteAnzeige();
  }
}

function updateEffekteAnzeige() {
  const √ºberanstrengung = parseInt(document.getElementById("√úberanstrengung")?.value || 0);
  const lp = parseInt(document.getElementById("Lebenspunkte")?.value || 0);
  const maxLp = parseInt(document.getElementById("Max. Lebenspunkte")?.value || 0);
  const ausdauer = parseInt(document.getElementById("Ausdauerpunkte")?.value || 0);
  const ausgabe = document.getElementById("effekteOutput");

  if (!ausgabe) return;

  // Effekt-Summen
  const summen = {
 AT: 0, PA: 0, FK: 0, "TaP/ZP": 0, GS: 0, KO: 0,
  MU: 0, KL: 0, IN: 0, KK: 0, GE: 0, FF: 0
  };

  // Effekt aus √úberanstrengung
  if (√ºberanstrengung > 0) {
    summen.KO -= √ºberanstrengung;
  }

  // Effekt: LP
  if (lp <= Math.round(maxLp * 0.25)) {
  summen.AT -= 3;
  summen.PA -= 3;
  summen.FK -= 3;
  summen["TaP/ZP"] -= 9;
  summen.GS -= 3;
} else if (lp <= Math.round(maxLp / 3)) {
  summen.AT -= 2;
  summen.PA -= 2;
  summen.FK -= 2;
  summen["TaP/ZP"] -= 6;
  summen.GS -= 2;
} else if (lp <= Math.round(maxLp / 2)) {
  summen.AT -= 1;
  summen.PA -= 1;
  summen.FK -= 1;
  summen["TaP/ZP"] -= 3;
  summen.GS -= 1;
}

  // Effekt: Ausdauer
const maxAusdauer = parseInt(document.getElementById("Max. Ausdauer")?.value || 0);
if (maxAusdauer > 0) {
  const grenzeDrittel = Math.round(maxAusdauer / 3);
  const grenzeViertel = Math.round(maxAusdauer * 0.25);

  if (ausdauer <= grenzeViertel) {
    summen.AT -= 2;
    summen.PA -= 2;
    summen.FK -= 2;
    summen["TaP/ZP"] -= 6;
  } else if (ausdauer <= grenzeDrittel) {
    summen.AT -= 1;
    summen.PA -= 1;
    summen.FK -= 1;
	summen["TaP/ZP"] -= 3;
  }
}

// Effekt: Astralpunkte ‚Üí Ausdauerpunkte reduzieren
const maxAsp = parseInt(document.getElementById("Max. Astralpunkte")?.value || 0);
const aktuelleAsp = parseInt(document.getElementById("Astralpunkte")?.value || 0);
const istAusdauernderZauberer = JSON.parse(localStorage.getItem("vorteilAusdauernderZauberer")) || false;

if (maxAsp > 0 && aktuelleAsp >= 0) {
  const verbraucht = maxAsp - aktuelleAsp;

  let stufe = 0;
  if (istAusdauernderZauberer) {
    stufe = Math.floor(verbraucht / 10); // alle 10 Punkte
  } else {
    stufe = Math.floor(verbraucht / 5);  // alle 5 Punkte
  }

if (stufe > 0) {
  summen["KO"] = (summen["KO"] || 0) - stufe;
}
}

function berechneWundenEffekte() {
  const basisEffekte = {
    "Generisch": { AT: -1, PA: -1, FK: -1, GE: -1, GS: -2 },
    "Kopf":      { MU: -2, KL: -2, IN: -2 },
    "Brust":     { AT: -1, PA: -1, FK: -1, KO: -1, KK: -1 },
    "Waffe":     { AT: -2, PA: -2, FK: -2, KK: -2, FF: -2 },
    "Schild":    { KK: -2, FF: -2 },
    "Bauch":     { AT: -1, PA: -1, FK: -1, KO: -1, KK: -1, GS: -1 },
    "Bein":      { AT: -1, PA: -1, FK: -1, GE: -1, GS: -1 }
  };

  const summen = {};

  wunden.forEach(({ art, anzahl }) => {
    const basis = basisEffekte[art] || {};
    for (const [key, wert] of Object.entries(basis)) {
      summen[key] = (summen[key] || 0) + wert * anzahl;
    }
  });

  return summen;
}


checkUndErh√∂heErsch√∂pfung();

// Wunden-Effekte einrechnen
const wundenEffekte = berechneWundenEffekte();
for (const [key, wert] of Object.entries(wundenEffekte)) {
  if (summen[key] !== undefined) {
    summen[key] += wert;
  } else {
    summen[key] = wert;
  }
}

  // Text erzeugen
  const effekteText = Object.entries(summen)
    .filter(([_, wert]) => wert !== 0)
    .map(([key, wert]) => `${wert} ${key}`)
    .join(" | ");

  const effekteWrapper = document.getElementById("effekteWrapper");

if (effekteText.trim()) {
  ausgabe.textContent = effekteText;
  effekteWrapper.classList.remove("hidden");
} else {
  ausgabe.textContent = "";
  effekteWrapper.classList.add("hidden");
}

}

document.addEventListener("keydown", function (e) {
  if (e.key === "Enter") {
    const activeElement = document.activeElement;
    if (activeElement && activeElement.id.endsWith("_change")) {
      const id = activeElement.id.replace("_change", "");
      applyChange(id);
    }
  }
});

    document.getElementById("saveBtn").addEventListener("click", () => {
      allIDs.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          localStorage.setItem(id, el.value);
        }
      });
      alert("Werte gespeichert!");
    });

    function toggleMinus(id) {
      const field = document.getElementById(id);
      if (!field) return;
      if (field.value === "") {
        field.value = "-";
      } else if (!field.value.startsWith("-")) {
        field.value = "-" + field.value;
      }
      field.focus();
    }

let regions = JSON.parse(localStorage.getItem('regions')) || [];
regions = regions.map(r => ({ ...r, npcs: r.npcs || [] }));

let currentRegionIndex = null;
let currentNPCIndex = null;
let regionSortMode = 'newest';
let npcSortMode = 'newest';

function saveRegions() {
  localStorage.setItem('regions', JSON.stringify(regions));
}

function setRegionSort(mode) {
  regionSortMode = mode;
  renderRegions();
}

function setNPCSort(mode) {
  npcSortMode = mode;
  renderNPCs();
}

function switchNPCTab(tabId) {
  document.querySelectorAll('.npc-inner-tab').forEach(tab => tab.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');
}

function renderRegions() {
  const list = document.getElementById('region-list');
  list.innerHTML = '';

  let sorted = [...regions];
  if (regionSortMode === 'asc') sorted.sort((a, b) => a.name.localeCompare(b.name));
  else if (regionSortMode === 'desc') sorted.sort((a, b) => b.name.localeCompare(a.name));
  else sorted.reverse();

  sorted.forEach((region, sortedIndex) => {
    const originalIndex = regions.indexOf(region);
    const li = document.createElement('li');
    li.className = 'card';

    const span = document.createElement('span');
    span.textContent = `${region.name} (${region.npcs.length} üë•)`;
    span.onclick = () => openRegion(originalIndex);

    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = '‚ùå';
    deleteBtn.onclick = e => {
      e.stopPropagation();
      if (confirm(`"${region.name}" l√∂schen?`)) {
        regions.splice(originalIndex, 1);
        saveRegions();
        renderRegions();
      }
    };

    const editBtn = document.createElement('button');
    editBtn.textContent = '‚öôÔ∏è';
    editBtn.onclick = e => {
      e.stopPropagation();
      const newName = prompt('Neuer Name f√ºr die Region:', region.name);
      if (newName && newName.trim() !== '') {
        regions[originalIndex].name = newName.trim();
        saveRegions();
        renderRegions();
      }
    };

    li.appendChild(span);
    li.appendChild(editBtn);  // ‚öôÔ∏è Symbol hinzuf√ºgen
    li.appendChild(deleteBtn);
    list.appendChild(li);
  });
}


function addRegion() {
  const name = document.getElementById('new-region-name').value.trim();
  if (!name) return;
  regions.push({ name, npcs: [] });
  saveRegions();
  renderRegions();
  document.getElementById('new-region-name').value = '';
}

function openRegion(index, pushState = true) {
  currentRegionIndex = index;
  document.getElementById('current-region-name').textContent = regions[index].name;
  renderNPCs();
  switchNPCTab('npc-region-tab');
  if (pushState) {
    history.pushState({ page: 'npc-region', regionIndex: index }, "", "#region-" + index);
  }
}


function backToRegions(pushState = true) {
  switchNPCTab('region-tab');
  if (pushState) {
    history.pushState({ page: 'region-list' }, "", "#regions");
  }
}

function renderNPCs() {
  const list = document.getElementById('npc-list');
  list.innerHTML = '';

  let npcs = [...regions[currentRegionIndex].npcs];
  if (npcSortMode === 'asc') npcs.sort((a, b) => a.name.localeCompare(b.name));
  else if (npcSortMode === 'desc') npcs.sort((a, b) => b.name.localeCompare(a.name));
  else npcs.reverse();

  npcs.forEach((npc, i) => {
    const li = document.createElement('li');
    li.className = 'card';

    const span = document.createElement('span');
    span.textContent = npc.name;
    span.onclick = () => openNPCDetail(i);

    const btn = document.createElement('button');
    btn.textContent = '‚ùå';
    btn.onclick = e => {
      e.stopPropagation();
      if (confirm(`"${npc.name}" l√∂schen?`)) {
        regions[currentRegionIndex].npcs.splice(i, 1);
        saveRegions();
        renderNPCs();
      }
    };

    li.appendChild(span);
    li.appendChild(btn);
    list.appendChild(li);
  });
}

function addNPC() {
  const name = document.getElementById('new-npc-name').value.trim();
  if (!name) return;
  regions[currentRegionIndex].npcs.push({
    name, race: '', age: '', role: '', quest: '',
    interaction: '', opinion: '', relations: []
  });
  saveRegions();
  renderNPCs();
  document.getElementById('new-npc-name').value = '';
}

function openNPCDetail(i) {
  currentNPCIndex = i;
  const npc = regions[currentRegionIndex].npcs[i];
  document.getElementById('npcName').value = npc.name;
  document.getElementById('npcRace').value = npc.race;
  document.getElementById('npcAge').value = npc.age;
  document.getElementById('npcRole').value = npc.role;
  document.getElementById('npcQuest').value = npc.quest;
  document.getElementById('npcInteraction').value = npc.interaction;
  document.getElementById('npcOpinion').value = npc.opinion;
  renderRelationOptions();
  renderRelations();
  switchNPCTab('npc-detail-tab');
  history.pushState({ page: 'npc-detail', npcIndex: i, regionIndex: currentRegionIndex }, "", "#npc-" + i);
}

function backToNPCs() {
  saveNPCDetail();
  renderNPCs();
  switchNPCTab('npc-region-tab');
  history.pushState({ page: 'npc-region', regionIndex: currentRegionIndex }, "", "#region-" + currentRegionIndex);
}

function showRegionMoveSelect() {
  const select = document.getElementById('npcMoveSelect');
  select.innerHTML = '';

  regions.forEach((region, index) => {
    if (index !== currentRegionIndex) {
      const option = document.createElement('option');
      option.value = index;
      option.textContent = region.name;
      select.appendChild(option);
    }
  });

  document.getElementById('npc-move-container').style.display = 'block';
}

function moveNPCToRegion() {
  const newRegionIndex = parseInt(document.getElementById('npcMoveSelect').value);
  if (isNaN(newRegionIndex)) return;

  const npc = regions[currentRegionIndex].npcs.splice(currentNPCIndex, 1)[0];
  regions[newRegionIndex].npcs.push(npc);

  saveRegions();
  alert(`NPC wurde nach "${regions[newRegionIndex].name}" verschoben.`);
  backToRegions(); // oder: backToNPCs() je nach gew√ºnschtem Verhalten
}

function saveNPCDetail() {
  const npc = regions[currentRegionIndex].npcs[currentNPCIndex];
  npc.name = document.getElementById('npcName').value;
  npc.race = document.getElementById('npcRace').value;
  npc.age = document.getElementById('npcAge').value;
  npc.role = document.getElementById('npcRole').value;
  npc.quest = document.getElementById('npcQuest').value;
  npc.interaction = document.getElementById('npcInteraction').value;
  npc.opinion = document.getElementById('npcOpinion').value;
  saveRegions();
}

function renderRelationOptions() {
  const select = document.getElementById('relationTarget');
  const isGlobal = document.getElementById('globalRelationToggle').checked;
  select.innerHTML = '';

  if (isGlobal) {
    regions.forEach((region, rIndex) => {
      region.npcs.forEach((npc, nIndex) => {
        if (rIndex === currentRegionIndex && nIndex === currentNPCIndex) return;

        const option = document.createElement('option');
        option.value = `${rIndex}-${nIndex}`;
        option.textContent = `${npc.name} (${region.name})`;
        select.appendChild(option);
      });
    });
  } else {
    regions[currentRegionIndex].npcs.forEach((npc, i) => {
      if (i === currentNPCIndex) return;

      const option = document.createElement('option');
      option.value = i;
      option.textContent = npc.name;
      select.appendChild(option);
    });
  }
}

function addRelation() {
  const label = document.getElementById('relationLabel').value.trim();
  const targetValue = document.getElementById('relationTarget').value;
  if (!label || !targetValue) return;

  let targetRegion, targetNPC;
  if (targetValue.includes('-')) {
    const [rIndex, nIndex] = targetValue.split('-').map(Number);
    targetRegion = rIndex;
    targetNPC = nIndex;
  } else {
    targetRegion = currentRegionIndex;
    targetNPC = parseInt(targetValue);
  }

  const npc = regions[currentRegionIndex].npcs[currentNPCIndex];
  npc.relations.push({ label, targetRegion, targetNPC });

  document.getElementById('relationLabel').value = '';
  renderRelations();
  saveRegions();
}

function renderRelations() {
  const list = document.getElementById("relationsList");
  list.innerHTML = "";

  const relations = regions[currentRegionIndex].npcs[currentNPCIndex].relations || [];

  relations.forEach((rel, index) => {
    let targetName = "???";
    let regionName = "???";

    for (let r = 0; r < regions.length; r++) {
      if (rel.global || r === currentRegionIndex) {
        const npc = regions[r].npcs[rel.target];
        if (npc) {
          targetName = npc.name;
          regionName = regions[r].name;
          break;
        }
      }
    }

    const li = document.createElement("li");
    li.innerHTML = `
      ${rel.label} ‚Üí ${targetName} (${regionName})
      <button class="delete-relation" data-index="${index}">‚ùå</button>
    `;

    list.appendChild(li);
  });

  // Event-Listener f√ºr L√∂sch-Buttons
  list.querySelectorAll(".delete-relation").forEach(button => {
    button.addEventListener("click", (e) => {
      const index = parseInt(e.target.dataset.index);
      regions[currentRegionIndex].npcs[currentNPCIndex].relations.splice(index, 1);
      saveRegions();
      renderRelations();
    });
  });
}

function getNPCNameByIndex(index) {
  const allNPCs = regions.flatMap(r => r.npcs);
  return allNPCs[index]?.name || 'Unbekannt';
}

window.addEventListener("popstate", (event) => {
  const state = event.state;

  if (!state) {
    backToRegions(false);
    return;
  }

  if (state.page === 'region-list') {
    backToRegions(false);
  } else if (state.page === 'npc-region' && typeof state.regionIndex === 'number') {
    openRegion(state.regionIndex, false);
  } else if (state.page === 'npc-detail' && typeof state.npcIndex === 'number' && typeof state.regionIndex === 'number') {
    openNPCDetail(state.npcIndex, false);
  }
});

// Enter-Taste ausl√∂sen
statusIDs.concat(geldIDs).forEach(id => {
  const changeField = document.getElementById(`${id}_change`);
  if (changeField) {
    changeField.addEventListener("keypress", function(e) {
      if (e.key === "Enter") {
        applyChange(id);
      }
    });
  }
});

function addRelation() {
  const label = document.getElementById("relationLabel").value.trim();
  const targetSelect = document.getElementById("relationTarget");
  const targetIndex = targetSelect.value;

  if (!label || targetIndex === "") return;

  const relation = {
    label,
    target: parseInt(targetIndex),
    global: document.getElementById("globalRelationToggle").checked
  };

  regions[currentRegionIndex].npcs[currentNPCIndex].relations.push(relation);
  saveRegions();
  renderRelations();

  document.getElementById("relationLabel").value = "";
}

function renderRelationOptions() {
  const select = document.getElementById("relationTarget");
  select.innerHTML = "";

  const isGlobal = document.getElementById("globalRelationToggle").checked;
  regions.forEach((region, rIndex) => {
    region.npcs.forEach((npc, nIndex) => {
      if (isGlobal || rIndex === currentRegionIndex) {
        if (!(rIndex === currentRegionIndex && nIndex === currentNPCIndex)) {
          const option = document.createElement("option");
          option.value = nIndex;
          option.textContent = `${npc.name} (${region.name})`;
          select.appendChild(option);
        }
      }
    });
  });
}

function berechneErschoepfungKonsequenzen() {
  const konstitution = parseInt(document.getElementById("Konstitution")?.value || 0);
  const ersch√∂pfungEl = document.getElementById("Ersch√∂pfung");
  const √ºberanstrengungEl = document.getElementById("√úberanstrengung");

  if (!ersch√∂pfungEl || !√ºberanstrengungEl) return;

  let ersch√∂pfung = parseInt(ersch√∂pfungEl.value || 0);
  let √ºberanstrengung = parseInt(√ºberanstrengungEl.value || 0);

  if (ersch√∂pfung > konstitution) {
    const differenz = ersch√∂pfung - konstitution;
    √ºberanstrengung += differenz;
    ersch√∂pfung = konstitution;

    ersch√∂pfungEl.value = ersch√∂pfung;
    √ºberanstrengungEl.value = √ºberanstrengung;
	localStorage.setItem("√úberanstrengung", √ºberanstrengung);

    localStorage.setItem("Ersch√∂pfung", ersch√∂pfung);
    localStorage.setItem("√úberanstrengung", √ºberanstrengung);
  }
  updateEffekteAnzeige();
}

function applyChange(id) {
if (id === "Astralpunkte") {
  const aspFeld = document.getElementById("Astralpunkte");
  const altAsp = parseInt(aspFeld.value || 0);
  const changeVal = parseFloat(document.getElementById("Astralpunkte_change")?.value.replace(",", ".") || 0);
  const neuerAsp = altAsp + changeVal;

  const maxAsp = parseInt(document.getElementById("Max. Astralpunkte")?.value || 0);
  const istAusdauernderZauberer = JSON.parse(localStorage.getItem("vorteilAusdauernderZauberer")) || false;
  const schwelle = istAusdauernderZauberer ? Math.floor(maxAsp / 2) : Math.floor(maxAsp / 3);

  if (changeVal < 0 && Math.abs(changeVal) >= schwelle) {
    const ersch√∂pfungField = document.getElementById("Ersch√∂pfung");
    const aktuelleErsch√∂pfung = parseInt(ersch√∂pfungField.value || 0);
    const neueErsch√∂pfung = aktuelleErsch√∂pfung + 1;
    ersch√∂pfungField.value = neueErsch√∂pfung;
    localStorage.setItem("Ersch√∂pfung", neueErsch√∂pfung);
    onStatusChange("Ersch√∂pfung");
  }
  // Astralpunkteverbrauch reduziert Ausdauerpunkte direkt
  const auFeld = document.getElementById("Ausdauerpunkte");
  const maxAU = parseInt(document.getElementById("Max. Ausdauer")?.value || 0);
  let aktuellerAU = parseInt(auFeld?.value || 0);

  let stufe = 0;
  if (istAusdauernderZauberer) {
    stufe = Math.floor((maxAsp - neuerAsp) / 10); // alle 10 ASP
  } else {
    stufe = Math.floor((maxAsp - neuerAsp) / 5);  // alle 5 ASP
  }

  const neueAU = Math.max(0, Math.min(maxAU, aktuellerAU - stufe));
  auFeld.value = neueAU;
  localStorage.setItem("Ausdauerpunkte", neueAU);
  onStatusChange("Ausdauerpunkte");
}

  const changeField = document.getElementById(`${id}_change`);
  const mainField = document.getElementById(id);
  if (!changeField || !mainField) return;

  const changeValue = parseFloat(changeField.value.replace(",", "."));
  if (isNaN(changeValue)) return;

  let currentValue = parseFloat(mainField.value) || 0;
  let newValue = currentValue + changeValue;
if (minZeroIDs.includes(id) && newValue < 0) {
  newValue = 0;
}

  // Sonderlogik f√ºr Ersch√∂pfung
  if (id === "Ersch√∂pfung") {
    const konstitution = parseFloat(document.getElementById("Konstitution")?.value) || 0;
    const √ºberanstrengungField = document.getElementById("√úberanstrengung");
    let √ºberanstrengung = parseFloat(√ºberanstrengungField?.value) || 0;

    const originalErsch√∂pfung = currentValue;
    const erh√∂hteErsch√∂pfung = originalErsch√∂pfung + changeValue;

    if (erh√∂hteErsch√∂pfung > konstitution) {
      const differenz = erh√∂hteErsch√∂pfung - konstitution;
      √ºberanstrengung += differenz;
      newValue -= differenz;

      if (√ºberanstrengungField) {
        √ºberanstrengungField.value = √ºberanstrengung;
        localStorage.setItem("√úberanstrengung", √ºberanstrengung);
      }
    }
  }

  // Begrenzung f√ºr Lebenspunkte
  if (id === "Lebenspunkte") {
    const maxLP = parseFloat(document.getElementById("Max. Lebenspunkte")?.value) || 0;
    if (newValue > maxLP) {
      newValue = maxLP;
    }
  }

  // Begrenzung f√ºr Ausdauerpunkte
  if (id === "Ausdauerpunkte") {
    const maxAU = parseFloat(document.getElementById("Max. Ausdauer")?.value) || 0;
    if (newValue > maxAU) {
      newValue = maxAU;
    }
  }

  // Begrenzung f√ºr Astralpunkte
  if (id === "Astralpunkte") {
    const maxAstra = parseFloat(document.getElementById("Max. Astralpunkte")?.value) || 0;
    if (newValue > maxAstra) {
      newValue = maxAstra;
    }
  }

  // Begrenzung f√ºr Karmalpunkte
  if (id === "Karmalpunkte") {
    const maxKarma = parseFloat(document.getElementById("Max. Karmalpunkte")?.value) || 0;
    if (newValue > maxKarma) {
      newValue = maxKarma;
    }
  }

  mainField.value = newValue;
  localStorage.setItem(id, newValue);

  // Status√§nderungen verarbeiten
  if (statusIDs.includes(id) || eigenschaftenIDs.includes(id)) {
    onStatusChange(id);
  }

  // √Ñnderungsfeld zur√ºcksetzen
  changeField.value = "";
  updateEffekteAnzeige();

}
function atemHolen() {
  const auField = document.getElementById("Ausdauerpunkte");
  const konstitutionField = document.getElementById("Konstitution");
  const ersch√∂pfungField = document.getElementById("Ersch√∂pfung");
  const maxAUField = document.getElementById("Max. Ausdauer");

  if (!auField || !konstitutionField || !ersch√∂pfungField || !maxAUField) return;

  const aktuellerAU = parseInt(auField.value || 0);
  const konstitution = parseInt(konstitutionField.value || 0);
  const maxAU = parseInt(maxAUField.value || 0);

  if (aktuellerAU >= maxAU) return;

  let neueAU = aktuellerAU + konstitution;
  if (neueAU > maxAU) neueAU = maxAU;

  const aktuelleErsch√∂pfung = parseInt(ersch√∂pfungField.value || 0);
  const neueErsch√∂pfung = aktuelleErsch√∂pfung + 1;

  auField.value = neueAU;
  ersch√∂pfungField.value = neueErsch√∂pfung;

  localStorage.setItem("Ausdauerpunkte", neueAU);
  localStorage.setItem("Ersch√∂pfung", neueErsch√∂pfung);

  onStatusChange("Ausdauerpunkte");
  onStatusChange("Ersch√∂pfung");

  updateEffekteAnzeige();
}

function toggleFernkampfEinstellungen() {
  const popup = document.getElementById("fernkampfEinstellungen");
  popup.classList.toggle("hidden");
  positionPopup(popup);
}

function toggleBogenPopup() {
  const popup = document.getElementById("bogenPopup");
  popup.classList.toggle("hidden");
  if (popup.classList.contains("hidden")) {
    aktualisiereEntfernungsDropdown();
  } else {
    positionPopup(popup);
  }
}

function positionPopup(popup) {
  const rect = event?.target?.getBoundingClientRect?.();
  if (!rect) return;
  popup.style.top = rect.bottom + window.scrollY + "px";
  popup.style.left = rect.left + window.scrollX + "px";
}

function aktualisiereEntfernungsDropdown() {
  const sehrNah = parseInt(document.getElementById("distSehrNah")?.value || "0");
  const nah = parseInt(document.getElementById("distNah")?.value || "0");
  const mittel = parseInt(document.getElementById("distMittel")?.value || "0");
  const weit = parseInt(document.getElementById("distWeit")?.value || "0");
  const extrem = parseInt(document.getElementById("distExtrem")?.value || "0");

  const dropdown = document.getElementById("entfernungDropdown");
  dropdown.innerHTML = "";

  const optionen = [
    { label: "Sehr nah", von: 0, bis: sehrNah, mod: -2 },
    { label: "Nah", von: sehrNah, bis: nah, mod: 0 },
    { label: "Mittel", von: nah, bis: mittel, mod: 4 },
    { label: "Weit", von: mittel, bis: weit, mod: 8 },
    { label: "Extrem weit", von: weit, bis: extrem, mod: 12 }
  ];

  optionen.forEach(opt => {
    if (opt.bis > opt.von) {
      const option = document.createElement("option");
      // Wert als JSON kodieren (z.‚ÄØB. sp√§ter f√ºr Modifikator-Nutzung)
      option.value = JSON.stringify({
        stufe: opt.label,
        von: opt.von,
        bis: opt.bis,
        mod: opt.mod
      });
      option.textContent = `${opt.label}: ${opt.von} bis ${opt.bis}`;
      dropdown.appendChild(option);
    }
  });
}

function bogenHinzufuegen() {
  const name = document.getElementById("bogenName").value.trim();
  if (!name) return alert("Bitte einen Namen f√ºr den Bogen eingeben.");

  const bogen = {
    name,
    distSehrNah: parseInt(document.getElementById("distSehrNah").value),
    distNah: parseInt(document.getElementById("distNah").value),
    distMittel: parseInt(document.getElementById("distMittel").value),
    distWeit: parseInt(document.getElementById("distWeit").value),
    distExtrem: parseInt(document.getElementById("distExtrem").value)
  };

  const boegen = JSON.parse(localStorage.getItem("boegenListe") || "[]");

  // Falls Name schon existiert, √ºberschreiben
  const index = boegen.findIndex(b => b.name === name);
  if (index >= 0) boegen[index] = bogen;
  else boegen.push(bogen);

  localStorage.setItem("boegenListe", JSON.stringify(boegen));
  aktualisiereBogenDropdown();
  alert("Bogen gespeichert!");
}

function aktualisiereBogenDropdown() {
  const dropdown = document.getElementById("bogenDropdown");
  dropdown.innerHTML = '<option value="">‚Äì bitte w√§hlen ‚Äì</option>';

  const boegen = JSON.parse(localStorage.getItem("boegenListe") || "[]");
  boegen.forEach(b => {
    const option = document.createElement("option");
    option.value = b.name;
    option.textContent = b.name;
    dropdown.appendChild(option);
  });
}

function ausgewaehltenBogenAnzeigen() {
  const name = document.getElementById("bogenDropdown").value;
  const boegen = JSON.parse(localStorage.getItem("boegenListe") || "[]");
  const bogen = boegen.find(b => b.name === name);
  if (!bogen) return;

  document.getElementById("distSehrNah").value = bogen.distSehrNah;
  document.getElementById("distNah").value = bogen.distNah;
  document.getElementById("distMittel").value = bogen.distMittel;
  document.getElementById("distWeit").value = bogen.distWeit;
  document.getElementById("distExtrem").value = bogen.distExtrem;
  document.getElementById("bogenName").value = bogen.name;

  document.getElementById("bogenAktionen").style.display = "block";
  localStorage.setItem("fern_bogenAuswahl", name); // <-- war falsch benannt als "selectedName"

  aktualisiereEntfernungsDropdown();
}

function aktualisiereEntfernungsDropdown() {
  const sehrNah = parseInt(document.getElementById("distSehrNah").value);
  const nah = parseInt(document.getElementById("distNah").value);
  const mittel = parseInt(document.getElementById("distMittel").value);
  const weit = parseInt(document.getElementById("distWeit").value);
  const extrem = parseInt(document.getElementById("distExtrem").value);

  const entfernungSelect = document.getElementById("entfernungDropdown");
  entfernungSelect.innerHTML = ""; // leeren

  entfernungSelect.innerHTML = `
    <option value='{"mod": -2}'>Sehr nah (bis ${sehrNah})</option>
    <option value='{"mod": 0}'>Nah (bis ${nah})</option>
    <option value='{"mod": 4}'>Mittel (bis ${mittel})</option>
    <option value='{"mod": 8}'>Weit (bis ${weit})</option>
    <option value='{"mod": 12}'>Extrem (bis ${extrem})</option>
  `;
}

function bogenBearbeiten() {
  bogenHinzufuegen(); // gleiche Funktion √ºberschreibt bei gleichem Namen
}

function bogenLoeschen() {
  const name = document.getElementById("bogenDropdown").value;
  if (!confirm(`Bogen "${name}" wirklich l√∂schen?`)) return;

  let boegen = JSON.parse(localStorage.getItem("boegenListe") || "[]");
  boegen = boegen.filter(b => b.name !== name);
  localStorage.setItem("boegenListe", JSON.stringify(boegen));
  aktualisiereBogenDropdown();

  document.getElementById("bogenName").value = "";
  ["distSehrNah", "distNah", "distMittel", "distWeit", "distExtrem"].forEach(id => {
    document.getElementById(id).value = "";
  });
  document.getElementById("bogenAktionen").style.display = "none";
}

function aktualisiereTierTrefferzonen() {
  const typ = document.getElementById("trefferzonenTyp").value;
  const menschBlock = document.getElementById("menschTrefferzonen");
  const tierBlock = document.getElementById("tierTrefferzonen");

  if (typ === "tier") {
    menschBlock.classList.add("hidden");
    tierBlock.classList.remove("hidden");
  } else {
    menschBlock.classList.remove("hidden");
    tierBlock.classList.add("hidden");
  }
}

function berechneFernkampfErschwernis() {
  let summe = 0;
console.log('Entfernung Dropdown value:', document.getElementById("entfernungDropdown").value);
console.log('entfernungMod:', JSON.parse(document.getElementById("entfernungDropdown").value || "{}").mod || 0);

  const zielgroesse = parseInt(document.getElementById("zielgroesseDropdown").value);
  const deckung = parseInt(document.getElementById("deckungDropdown").value);
  let bewegung = parseInt(document.getElementById("bewegungDropdown").value);
  const sichtRaw = JSON.parse(document.getElementById("sichtDropdown").value);
  const vorteilDaemmerung = document.getElementById("vorteilDaemmerung").checked;
  const vorteilNacht = document.getElementById("vorteilNacht").checked;
  const trefferzonenAktiv = document.getElementById("trefferzonenSystem").checked;
  const ohneTrefferzone = document.getElementById("ohneTrefferzone").checked;
  const kampfH = document.getElementById("kampfgetuemmelH").checked;
  const kampfNS = document.getElementById("kampfgetuemmelNS").checked;
  const anzahlTeilnehmer = parseInt(document.getElementById("kampfTeilnehmer").value || "0");

  // Sicht
const istNachtblind = document.getElementById("nachtblind").checked;

let sicht = sichtRaw.basis;
if (vorteilDaemmerung) {
  sicht = sichtRaw.daemmerung;
} else if (vorteilNacht) {
  sicht = sichtRaw.nacht;
} else if (istNachtblind) {
  sicht = sichtRaw.basis * 2; // Nachtblindheit: doppelter Basiswert
}


  // Trefferzonen erh√∂ht Bewegung
  if (trefferzonenAktiv && !ohneTrefferzone) bewegung += 2;

  // Kampfget√ºmmel setzt Bewegung auf 0
  if (kampfH || kampfNS) bewegung = 0;

  // Teil 1: Begrenzte Summe von -2 bis +8
  let zwischensumme = zielgroesse + deckung + bewegung + sicht;
  zwischensumme = Math.max(-2, zwischensumme);
  summe += zwischensumme;

  // Entfernung
  const entfernungMod = JSON.parse(document.getElementById("entfernungDropdown").value || "{}").mod || 0;
  summe += entfernungMod;

  // Entfernungssinn
  if (document.getElementById("vorteilEntfernungssinn").checked) summe -= 2;

  // Ein√§ugig <10
  if (document.getElementById("einaugigDist10").checked) summe += 4;

  // Farbenblind >50
  if (document.getElementById("farbenblindDist50").checked) summe += 4;

  // Meisterentscheid
  if (document.getElementById("mitMeisterErschwernis").checked) {
    summe += parseInt(document.getElementById("meisterErschwernis").value || "0");
  }

  // Aktionen zielen ‚Äì Erleichterung berechnen
const aktionenZielen = parseInt(document.getElementById("aktionenZielenAnzahl").value || "0");
const fertigkeit = document.getElementById("sonderfertigkeit").value;

let erleichterung = 0;

if (fertigkeit === "N") {
  erleichterung = Math.floor(aktionenZielen / 2) * -1;
} else {
  erleichterung = aktionenZielen * -1;
}

erleichterung = Math.max(-4, Math.min(0, erleichterung)); // begrenzen
summe += erleichterung;

  // Kampfget√ºmmel-Zusatz
  if (kampfH) summe += anzahlTeilnehmer * 2;
  else if (kampfNS) summe += anzahlTeilnehmer * 3;

  // Sonstige Modifikatoren
  if (document.getElementById("modSteilschussUnten").checked) summe += 2;
  if (document.getElementById("modSteilschussOben").checked) summe += 4;
  if (document.getElementById("modBoigerSeitenwind").checked) summe += 4;
  if (document.getElementById("modStarkerBoigerSeitenwind").checked) summe += 8;

  // Schnellschuss
  if (document.getElementById("modSchnellschuss").checked) {
    const stufe = document.getElementById("sonderfertigkeit").value;
    summe += (stufe === "N") ? 2 : (stufe === "S") ? 1 : 0;
  }

  if (document.getElementById("modzweiterSchuss").checked) summe += 4;

  // Trefferzonen-Modifikator
 if (trefferzonenAktiv && !ohneTrefferzone) {
    const stufe = document.getElementById("sonderfertigkeit").value;
    const typ = document.getElementById("trefferzonenTyp").value;

    if (typ === "mensch") {
      const zone = document.getElementById("trefferzoneDropdown").value;
      const zoneWert = trefferzonenModifikatoren[zone]?.[stufe] || 0;
      summe += zoneWert;
    } else if (typ === "tier") {
      const zone = document.getElementById("tierzoneDropdown").value;
      if (zone === "schwanz") {
        // Hinweis anzeigen, aber keinen automatischen Wert vergeben
        // Alternativ k√∂nnte man hier ein console.log machen oder sp√§ter ein Infofeld f√ºllen
      } else {
        const zoneWert = tierTrefferzonenModifikatoren[zone]?.[stufe] || 0;
        summe += zoneWert;
      }
    }
  }


  // Ergebnis anzeigen
  document.getElementById("erschwernisAnzeige").textContent = `${summe > 0 ? "+" : ""}${summe}`;
}

const tierTrefferzonenModifikatoren = {
  rumpf: { N: 4, S: 3, M: 2 },
  bein: { N: 10, S: 7, M: 5 },
  verwundbar: { N: 12, S: 8, M: 6 },
  kopf: { N: 16, S: 11, M: 8 },
  sinnesorgane: { N: 16, S: 11, M: 8 }
  // Schwanz wird manuell eingetragen, daher hier ignorieren
};

const idsZuBeobachten = [
  "zielgroesseDropdown", "deckungDropdown", "bewegungDropdown", "sichtDropdown",
  "trefferzonenSystem", "trefferzonenTyp", "trefferzoneDropdown", "tierzoneDropdown",
  "entfernungDropdown", "checkboxEinaugig", "einaugigDist10",
  "checkboxFarbenblind", "farbenblindDist50", "vorteilDaemmerung", "vorteilNacht",
  "vorteilEntfernungssinn", "mitMeisterErschwernis", "meisterErschwernis",
  "Zielenerleichertung", "sonderfertigkeit", "kampfgetuemmelH", "kampfgetuemmelNS",
  "kampfTeilnehmer", "modSteilschussUnten", "modSteilschussOben",
  "modBoigerSeitenwind", "modStarkerBoigerSeitenwind",
  "modSchnellschuss", "modzweiterSchuss", "aktionenZielenAnzahl", "nachtblind", "ohneTrefferzone"
];

idsZuBeobachten.forEach(id => {
  const el = document.getElementById(id);
  if (!el) return;
  el.addEventListener("input", berechneFernkampfErschwernis);
  el.addEventListener("change", berechneFernkampfErschwernis);
});

function setupFernkampfAutoSave() {
  const fernkampfTab = document.getElementById("fernkampfTab");

  fernkampfTab.querySelectorAll("select, input[type=checkbox], input[type=number], input[type=text]").forEach(el => {
    const id = el.id;
    if (!id) return;

    // Laden beim Start
    const gespeicherterWert = localStorage.getItem("fern_" + id);
    if (gespeicherterWert !== null) {
      if (el.type === "checkbox") {
        el.checked = gespeicherterWert === "true";
      } else {
        el.value = gespeicherterWert;
      }
    }

    // Speichern bei √Ñnderung
    el.addEventListener("change", () => {
      if (el.type === "checkbox") {
        localStorage.setItem("fern_" + id, el.checked);
      } else {
        localStorage.setItem("fern_" + id, el.value);
      }
    });
  });
}

function toggleModPopup() {
  const popup = document.getElementById("modPopup");
  popup.classList.toggle("hidden");
}

function renderTabButtons() {
  const container = document.querySelector(".tabs");
  container.innerHTML = "";

  // Aktive Tabs aus localStorage
  const aktiveTabs = JSON.parse(localStorage.getItem("aktiveTabs")) || allTabs.map(t => t.id);

  allTabs.forEach(tab => {
    if (aktiveTabs.includes(tab.id)) {
      const button = document.createElement("button");
      button.className = "tab-button";
      button.textContent = tab.label;
      button.onclick = () => showTab(tab.id);
      container.appendChild(button);
    }
  });

  // Reiter verwalten Button immer anh√§ngen
  const verwaltenBtn = document.createElement("button");
  verwaltenBtn.className = "tab-button";
  verwaltenBtn.textContent = "Reiter verwalten";
  verwaltenBtn.onclick = () => showTab("tabManagerTab");
  container.appendChild(verwaltenBtn);
}

function renderTabManager() {
  const container = document.getElementById("tabManagerOptions");
  container.className = "checkbox-column";
  container.innerHTML = "";

  // Statt lokale Kopie nur einmal zu machen, mache sie bei jeder √Ñnderung neu
  allTabs.forEach(tab => {
    const row = document.createElement("div");
    row.className = "checkbox-row";

    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";

    // Zustand aus aktuellem Storage lesen
    checkbox.checked = JSON.parse(localStorage.getItem("aktiveTabs") || "[]").includes(tab.id);

    checkbox.onchange = () => {
      // Neue Liste auf Basis des aktuellen Zustands
      const aktuelle = new Set(JSON.parse(localStorage.getItem("aktiveTabs")) || []);

      if (checkbox.checked) {
        aktuelle.add(tab.id);
      } else {
        aktuelle.delete(tab.id);
      }

      localStorage.setItem("aktiveTabs", JSON.stringify([...aktuelle]));
      renderTabButtons();
    };

    const label = document.createElement("label");
    label.textContent = tab.label;
    label.prepend(checkbox);

    row.appendChild(label);
    container.appendChild(row);
  });
}


  </script>

</body>
</html>